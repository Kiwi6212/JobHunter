{% extends "base.html" %}

{% block title %}Dashboard - JobHunter{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2 data-i18n="dashboard_title">Tableau de bord des offres</h2>
    <div class="stats-summary">
        <div class="stat-card">
            <span class="stat-number">{{ stats.total_offers }}</span>
            <span class="stat-label" data-i18n="stat_total">Total offres</span>
        </div>
        <div class="stat-card">
            <span class="stat-number" id="stat-cv-sent">{{ stats.cv_sent }}</span>
            <span class="stat-label" data-i18n="stat_cv">CV envoyés</span>
        </div>
        <div class="stat-card">
            <span class="stat-number" id="stat-follow-ups">{{ stats.follow_ups }}</span>
            <span class="stat-label" data-i18n="stat_followup">Relances</span>
        </div>
        <div class="stat-card">
            <span class="stat-number" id="stat-interviews">{{ stats.interviews }}</span>
            <span class="stat-label" data-i18n="stat_interviews">Entretiens</span>
        </div>
    </div>
</div>

{% if offers %}
<!-- Filters bar -->
<div class="filters-bar">
    <div class="filter-group">
        <label for="filter-status" data-i18n="filter_status">Statut</label>
        <select id="filter-status">
            <option value="" data-i18n="filter_all">Tous</option>
            {% for s in statuses %}
            <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label for="filter-source" data-i18n="filter_source">Source</label>
        <select id="filter-source">
            <option value="" data-i18n="filter_all">Tous</option>
            {% for src in sources %}
            <option value="{{ src }}">{{ src }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label for="filter-company" data-i18n="filter_company">Entreprise</label>
        <input type="text" id="filter-company"
               data-i18n-placeholder="filter_company_ph"
               placeholder="Filtrer par entreprise...">
    </div>
    <div class="filter-group">
        <label for="filter-search" data-i18n="filter_search">Recherche</label>
        <input type="text" id="filter-search"
               data-i18n-placeholder="filter_search_ph"
               placeholder="Rechercher titre, entreprise...">
    </div>
    <div class="filter-group filter-toggle">
        <label>
            <input type="checkbox" id="show-all-offers">
            <span data-i18n="filter_all_offers">Afficher toutes les offres</span>
        </label>
    </div>
    <div class="filter-group filter-toggle">
        <label>
            <input type="checkbox" id="show-recruiters">
            <span data-i18n="filter_recruiters">Afficher les recruteurs potentiels</span>
        </label>
    </div>
    <button class="btn btn-secondary btn-small" id="filters-reset" data-i18n="btn_reset">Réinitialiser</button>
    <button class="btn btn-primary btn-small" id="export-csv" data-i18n="btn_export_csv">Exporter CSV</button>
</div>

<div class="table-container">
    <div class="table-scroll">
    <table class="offers-table" id="offers-table">
        <thead>
            <tr>
                <th class="sortable" data-col="title"><span data-i18n="col_title">Titre</span> <span class="sort-icon"></span></th>
                <th class="sortable" data-col="company"><span data-i18n="col_company">Entreprise</span> <span class="sort-icon"></span></th>
                <th class="sortable" data-col="location"><span data-i18n="col_location">Lieu</span> <span class="sort-icon"></span></th>
                <th class="sortable" data-col="source"><span data-i18n="col_source">Source</span> <span class="sort-icon"></span></th>
                <th class="sortable" data-col="date"><span data-i18n="col_date">Publié</span> <span class="sort-icon"></span></th>
                <th class="sortable" data-col="score"><span data-i18n="col_score">Score</span> <span class="sort-icon"></span></th>
                <th data-i18n="col_status">Statut</th>
                <th data-i18n="col_cv">CV envoyé</th>
                <th data-i18n="col_followup">Relance</th>
                <th data-i18n="col_notes">Notes</th>
                <th data-i18n="col_link">Lien</th>
            </tr>
        </thead>
        <tbody>
            {% for offer in offers %}
            <tr class="offer-row"
                data-offer-id="{{ offer.id }}"
                data-title="{{ offer.title|lower }}"
                data-company="{{ offer.company|lower }}"
                data-source="{{ offer.source }}"
                data-status="{{ offer.tracking.status if offer.tracking else 'New' }}"
                data-location="{{ (offer.location or '')|lower }}"
                data-date="{{ offer.posted_date.strftime('%Y-%m-%d') if offer.posted_date else '' }}"
                data-score="{{ offer.relevance_score or 0 }}"
                data-offer-type="{{ offer.offer_type or 'job' }}"
                data-target="{{ '1' if offer.id in target_ids else '0' }}">
                <td class="col-title">
                    <a href="{{ url_for('main.offer_detail', offer_id=offer.id) }}" class="offer-title">{{ offer.title }}</a>
                </td>
                <td class="col-company">{{ offer.company }}</td>
                <td class="col-location">{{ offer.location or 'N/A' }}</td>
                <td><span class="badge badge-{{ offer.source }}">{{ offer.source }}</span></td>
                <td class="col-date">{{ offer.posted_date.strftime('%Y-%m-%d') if offer.posted_date else 'N/A' }}</td>
                <td class="col-score">{{ '%.0f' % (offer.relevance_score or 0) }}</td>
                <td>
                    <select class="status-select status-color-{{ (offer.tracking.status if offer.tracking else 'New').lower().replace(' ', '-') }}"
                            data-field="status">
                        {% for s in statuses %}
                        <option value="{{ s }}" {{ 'selected' if (offer.tracking and offer.tracking.status == s) or (not offer.tracking and s == 'New') }}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td class="col-checkbox">
                    <input type="checkbox" class="tracking-checkbox" data-field="cv_sent"
                           {{ 'checked' if offer.tracking and offer.tracking.cv_sent }}>
                    <span class="date-label">{{ offer.tracking.date_sent.strftime('%m/%d') if offer.tracking and offer.tracking.date_sent else '' }}</span>
                </td>
                <td class="col-checkbox">
                    <input type="checkbox" class="tracking-checkbox" data-field="follow_up_done"
                           {{ 'checked' if offer.tracking and offer.tracking.follow_up_done }}>
                    <span class="date-label">{{ offer.tracking.follow_up_date.strftime('%m/%d') if offer.tracking and offer.tracking.follow_up_date else '' }}</span>
                </td>
                <td class="col-notes">
                    <input type="text" class="notes-input" data-field="notes"
                           value="{{ offer.tracking.notes or '' if offer.tracking else '' }}"
                           placeholder="...">
                </td>
                <td>
                    <a href="{{ offer.url }}" target="_blank" class="btn btn-small btn-view"
                       data-i18n="btn_view" title="View original offer">Voir</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <div class="table-footer">
        <span>
            <span id="visible-count">{{ offers|length }}</span> / {{ offers|length }}
            <span data-i18n="offers_count">offres</span>
        </span>
        <span class="pagination-controls">
            <button class="btn btn-small" id="page-prev" disabled>&laquo; Prev</button>
            <span id="page-info">Page 1</span>
            <button class="btn btn-small" id="page-next">Next &raquo;</button>
        </span>
    </div>
</div>
{% else %}
<div class="empty-state">
    <h3 data-i18n="empty_title">Aucune offre trouvée</h3>
    <p data-i18n="empty_text">Lancez les scrapers pour remplir le tableau de bord.</p>
    <code>python scripts/run_scrapers.py</code>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
