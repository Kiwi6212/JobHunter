{% extends "base.html" %}

{% block title %}Statistics - JobHunter{% endblock %}

{% block extra_css %}
<style>
.stats-page h2 {
    font-size: 2rem;
    margin-bottom: 2rem;
    color: var(--text-primary);
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-top: 2rem;
}

@media (max-width: 900px) {
    .charts-grid { grid-template-columns: 1fr; }
}

.chart-card {
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 1.5rem;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.chart-card h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1.2rem;
}

.chart-wrapper {
    position: relative;
    height: 280px;
}

.chart-wrapper.tall {
    height: 340px;
}

.chart-card--full {
    grid-column: 1 / -1;
}
</style>
{% endblock %}

{% block content %}
<div class="stats-page">
    <h2 data-i18n="page_title">Statistiques de candidature</h2>

    <div class="stats-grid">
        <div class="stat-card large">
            <span class="stat-number">{{ stats.total_offers }}</span>
            <span class="stat-label" data-i18n="stat_total">Total offres trouvées</span>
        </div>
        <div class="stat-card large">
            <span class="stat-number">{{ stats.tracked }}</span>
            <span class="stat-label" data-i18n="stat_tracked">Offres suivies</span>
        </div>
        <div class="stat-card large">
            <span class="stat-number">{{ stats.cv_sent }}</span>
            <span class="stat-label" data-i18n="stat_cv">CV envoyés</span>
        </div>
        <div class="stat-card large">
            <span class="stat-number">{{ stats.follow_ups }}</span>
            <span class="stat-label" data-i18n="stat_followup">Relances effectuées</span>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3 data-i18n="chart_source">Offres par source</h3>
            <div class="chart-wrapper">
                <canvas id="chart-source"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 data-i18n="chart_status">Statuts de candidature</h3>
            <div class="chart-wrapper">
                <canvas id="chart-status"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 data-i18n="chart_companies">Top 10 entreprises</h3>
            <div class="chart-wrapper tall">
                <canvas id="chart-companies"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 data-i18n="chart_scores">Répartition des scores de pertinence</h3>
            <div class="chart-wrapper">
                <canvas id="chart-scores"></canvas>
            </div>
        </div>
        {% if has_cv %}
        <div class="chart-card chart-card--full">
            <h3 data-i18n="chart_cv_scores">Répartition des scores de matching CV</h3>
            <div class="chart-wrapper">
                <canvas id="chart-cv-scores"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
(function () {
    "use strict";

    var CHART_DATA = {{ chart_data | tojson }};
    var HAS_CV = {{ 'true' if has_cv else 'false' }};

    // ── Color palette ───────────────────────────────────────────────
    var PALETTE = [
        "#2563eb", "#8b5cf6", "#10b981", "#f59e0b",
        "#ef4444", "#14b8a6", "#f97316", "#6366f1",
        "#ec4899", "#64748b"
    ];

    var STATUS_COLORS = {
        "New":         "#818cf8",
        "Applied":     "#60a5fa",
        "Followed up": "#fbbf24",
        "Interview":   "#f472b6",
        "Accepted":    "#34d399",
        "Rejected":    "#f87171",
        "No response": "#94a3b8",
    };

    // ── Read CSS variables for current theme ────────────────────────
    function cssVar(name) {
        return getComputedStyle(document.documentElement)
            .getPropertyValue(name).trim();
    }

    function themeColors() {
        return {
            text:   cssVar("--text-primary")   || "#1e293b",
            sub:    cssVar("--text-secondary")  || "#64748b",
            border: cssVar("--border-color")    || "#e2e8f0",
            card:   cssVar("--card-bg")         || "#ffffff",
        };
    }

    // ── Chart registry (to destroy before rebuilding) ───────────────
    var charts = {};

    function destroyAll() {
        Object.keys(charts).forEach(function (k) { charts[k].destroy(); });
        charts = {};
    }

    // ── Build all charts ────────────────────────────────────────────
    function buildCharts() {
        destroyAll();
        var c = themeColors();

        Chart.defaults.color       = c.text;
        Chart.defaults.borderColor = c.border;
        Chart.defaults.font        = { family: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif", size: 12 };

        buildSourceChart(c);
        buildStatusChart(c);
        buildCompaniesChart(c);
        buildScoresChart(c);
        if (HAS_CV) buildCvScoresChart(c);
    }

    // (a) Doughnut — offers per source
    function buildSourceChart(c) {
        var labels = Object.keys(CHART_DATA.sources);
        var data   = labels.map(function (k) { return CHART_DATA.sources[k]; });
        var colors = labels.map(function (_, i) { return PALETTE[i % PALETTE.length]; });

        charts.source = new Chart(document.getElementById("chart-source"), {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, borderColor: c.card }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "right", labels: { color: c.text, boxWidth: 14, padding: 12 } },
                    tooltip: { callbacks: {
                        label: function (ctx) {
                            var total = ctx.dataset.data.reduce(function (a, b) { return a + b; }, 0);
                            var pct = total ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                            return " " + ctx.parsed + " (" + pct + "%)";
                        }
                    }}
                },
                cutout: "60%"
            }
        });
    }

    // (b) Doughnut — application statuses
    function buildStatusChart(c) {
        var allStatuses = ["New", "Applied", "Followed up", "Interview", "Accepted", "Rejected", "No response"];
        var labels = [], data = [], colors = [];

        allStatuses.forEach(function (s) {
            var count = CHART_DATA.statuses[s] || 0;
            if (count > 0) {
                labels.push(s);
                data.push(count);
                colors.push(STATUS_COLORS[s] || "#94a3b8");
            }
        });

        // If no tracking data yet, show placeholder
        if (data.length === 0) {
            labels = ["No data"];
            data   = [1];
            colors = [c.border];
        }

        charts.status = new Chart(document.getElementById("chart-status"), {
            type: "doughnut",
            data: {
                labels: labels,
                datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, borderColor: c.card }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "right", labels: { color: c.text, boxWidth: 14, padding: 12 } },
                },
                cutout: "60%"
            }
        });
    }

    // (c) Horizontal bar — top 10 companies
    function buildCompaniesChart(c) {
        var companies = Object.keys(CHART_DATA.companies);
        var counts    = companies.map(function (k) { return CHART_DATA.companies[k]; });

        charts.companies = new Chart(document.getElementById("chart-companies"), {
            type: "bar",
            data: {
                labels: companies,
                datasets: [{
                    label: "Offres",
                    data: counts,
                    backgroundColor: "rgba(37, 99, 235, 0.75)",
                    borderColor: "#2563eb",
                    borderWidth: 1,
                    borderRadius: 6,
                }]
            },
            options: {
                indexAxis: "y",
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: c.sub, precision: 0 },
                        grid:  { color: c.border },
                        border: { color: c.border }
                    },
                    y: {
                        ticks: { color: c.text },
                        grid:  { display: false },
                        border: { color: c.border }
                    }
                }
            }
        });
    }

    // (d) Bar — score distribution
    function buildScoresChart(c) {
        var bucketLabels = [
            "0–10", "10–20", "20–30", "30–40", "40–50",
            "50–60", "60–70", "70–80", "80–90", "90–100"
        ];

        // Color gradient: gray → blue as score increases
        var barColors = bucketLabels.map(function (_, i) {
            var opacity = 0.35 + (i / 9) * 0.65;
            return "rgba(37, 99, 235, " + opacity.toFixed(2) + ")";
        });

        charts.scores = new Chart(document.getElementById("chart-scores"), {
            type: "bar",
            data: {
                labels: bucketLabels,
                datasets: [{
                    label: "Offres",
                    data: CHART_DATA.scores,
                    backgroundColor: barColors,
                    borderColor: "#2563eb",
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: c.sub },
                        grid:  { display: false },
                        border: { color: c.border }
                    },
                    y: {
                        ticks: { color: c.sub, precision: 0 },
                        grid:  { color: c.border },
                        border: { color: c.border }
                    }
                }
            }
        });
    }

    // (e) Bar — CV match score distribution (green gradient, conditional)
    function buildCvScoresChart(c) {
        var canvas = document.getElementById("chart-cv-scores");
        if (!canvas) return;

        var bucketLabels = [
            "0–10", "10–20", "20–30", "30–40", "40–50",
            "50–60", "60–70", "70–80", "80–90", "90–100"
        ];

        // Color gradient: gray → green as score increases
        var barColors = bucketLabels.map(function (_, i) {
            var opacity = 0.30 + (i / 9) * 0.70;
            return "rgba(16, 185, 129, " + opacity.toFixed(2) + ")";
        });

        charts.cvScores = new Chart(canvas, {
            type: "bar",
            data: {
                labels: bucketLabels,
                datasets: [{
                    label: "Offres",
                    data: CHART_DATA.cv_scores,
                    backgroundColor: barColors,
                    borderColor: "#10b981",
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        ticks: { color: c.sub },
                        grid:  { display: false },
                        border: { color: c.border }
                    },
                    y: {
                        ticks: { color: c.sub, precision: 0 },
                        grid:  { color: c.border },
                        border: { color: c.border }
                    }
                }
            }
        });
    }

    // ── Build on load ───────────────────────────────────────────────
    buildCharts();

    // ── Rebuild when dark/light theme is toggled ────────────────────
    new MutationObserver(function (mutations) {
        mutations.forEach(function (m) {
            if (m.attributeName === "data-theme") buildCharts();
        });
    }).observe(document.documentElement, { attributes: true });

    // ── Stats page translations ─────────────────────────────────────
    var STATS_T = {
        fr: {
            page_title:     "Statistiques de candidature",
            stat_total:     "Total offres trouvées",
            stat_tracked:   "Offres suivies",
            stat_cv:        "CV envoyés",
            stat_followup:  "Relances effectuées",
            chart_source:   "Offres par source",
            chart_status:   "Statuts de candidature",
            chart_companies:"Top 10 entreprises",
            chart_scores:    "Répartition des scores de pertinence",
            chart_cv_scores: "Répartition des scores de matching CV",
        },
        en: {
            page_title:     "Application Statistics",
            stat_total:     "Total Offers Found",
            stat_tracked:   "Offers Tracked",
            stat_cv:        "CVs Sent",
            stat_followup:  "Follow-ups Done",
            chart_source:   "Offers by source",
            chart_status:   "Application statuses",
            chart_companies:"Top 10 companies",
            chart_scores:    "Relevance score distribution",
            chart_cv_scores: "CV matching score distribution",
        }
    };

    function applyStatsLang(lang) {
        var t = STATS_T[lang] || STATS_T.fr;
        var els = document.querySelectorAll("[data-i18n]");
        for (var i = 0; i < els.length; i++) {
            var key = els[i].getAttribute("data-i18n");
            if (t[key] !== undefined) els[i].textContent = t[key];
        }
    }

    // Apply saved language on load
    applyStatsLang(localStorage.getItem("jh-lang") || "fr");

    // React to language toggle from navbar
    document.addEventListener("jh-lang-change", function (e) {
        applyStatsLang(e.detail.lang);
    });

})();
</script>
{% endblock %}
